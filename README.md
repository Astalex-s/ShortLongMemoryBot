# Telegram AI Bot

Telegram бот, который отвечает на вопросы пользователей с помощью AI через ProxyAPI (GPT-4.1-mini).

## Установка

1. Клонируйте репозиторий или скачайте файлы проекта

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

4. Заполните переменные окружения в файле `.env`:
   - `TELEGRAM_BOT_TOKEN` - токен вашего Telegram бота (получить у [@BotFather](https://t.me/BotFather))
   - `OPENAI_API_KEY` - API ключ для ProxyAPI
    - `DB_HOST` - хост PostgreSQL (по умолчанию `85.198.103.173`)
    - `DB_PORT` - порт PostgreSQL (по умолчанию `5432`)
    - `DB_NAME` - имя базы данных (по умолчанию `memorybot`)
    - `DB_USER` - пользователь PostgreSQL (по умолчанию `postgres`)
    - `DB_PASSWORD` - пароль PostgreSQL

5. PostgreSQL база данных будет на сервере `85.198.103.173`. Таблицы создадутся автоматически при первом запуске бота.

## Запуск

### Локальный запуск

Запустите бота командой:
```bash
python bot.py
```

### Запуск в Docker (Docker Compose)

Проект использует `docker-compose` для развертывания всей инфраструктуры (Бот + PostgreSQL + pgAdmin).

1. Убедитесь, что у вас установлены Docker и Docker Compose.

2. Соберите и запустите контейнеры:
```bash
docker-compose up -d --build
```

3. Просмотр статуса контейнеров:
```bash
docker-compose ps
```

4. Просмотр логов:
```bash
docker-compose logs -f bot
```

### Доступ к pgAdmin

После запуска pgAdmin будет доступен по адресу: `http://ваш-ip:5050` (или `http://localhost:5050` при локальном запуске).
Логин и пароль настраиваются через секреты/переменные окружения `PGADMIN_EMAIL` и `PGADMIN_PASSWORD`.

## CI/CD с GitHub Actions

Проект включает автоматизированный workflow для сборки и развертывания через GitHub Actions.

### Автоматическое развертывание

При push в ветку `main` автоматически:
1. Собирается Docker образ
2. Образ пушится в GitHub Container Registry (ghcr.io)
3. Подключается к удаленному серверу по SSH
4. Развертывается новый контейнер

### Настройка секретов

В настройках репозитория (Settings → Secrets and variables → Actions) добавьте необходимые секреты для деплоя:

- `SSH_PRIVATE_KEY` - Приватный SSH ключ для подключения к серверу
- `SSH_HOST` - IP адрес или доменное имя сервера
- `SSH_USER` - Имя пользователя для SSH подключения
- `SSH_PORT` - Порт SSH (опционально, по умолчанию 22)
- `GHCR_TOKEN` - Personal Access Token (PAT) с правами `read:packages` и `write:packages` для GitHub Container Registry
- `TELEGRAM_BOT_TOKEN` - Токен Telegram бота
- `OPENAI_API_KEY` - API ключ для ProxyAPI
- `DB_NAME` - Имя базы данных
- `DB_USER` - Пользователь PostgreSQL
- `DB_PASSWORD` - Пароль PostgreSQL
- `PGADMIN_EMAIL` - Email для входа в pgAdmin
- `PGADMIN_PASSWORD` - Пароль для входа в pgAdmin

Подробная инструкция по настройке SSH и развертыванию находится в [.github/workflows/README.md](.github/workflows/README.md).

## Использование

1. Найдите вашего бота в Telegram
2. Отправьте команду `/start` для начала работы
3. Задавайте любые вопросы боту - он будет отвечать с помощью AI

## Команды бота

- `/start` - Начать работу с ботом
- `/help` - Показать справку
- `/clear` - Очистить историю разговора

## Структура проекта

Проект организован в модульную структуру:

```
ShortLongMemoryBot/
├── config/                 # Конфигурация приложения
│   ├── __init__.py
│   ├── logging_config.py  # Настройка логирования
│   └── settings.py         # Настройки и переменные окружения
├── utils/                  # Вспомогательные модули
│   ├── __init__.py
│   ├── ai_client.py        # Клиент для работы с OpenAI API
│   ├── messages.py         # Текстовые сообщения бота
│   ├── keyboards.py        # Клавиатуры и кнопки
│   ├── memory.py           # Модуль короткой памяти (оперативная)
│   ├── memory_manager.py   # Менеджер памяти (единый экземпляр)
│   └── db_manager.py       # Менеджер PostgreSQL для долгосрочной памяти
├── handlers/               # Обработчики событий
│   ├── __init__.py
│   ├── commands.py         # Обработчики команд (/start, /help)
│   └── messages.py         # Обработчики текстовых сообщений
├── bot.py                  # Основной файл запуска бота
├── requirements.txt        # Зависимости проекта
├── Dockerfile              # Docker образ для сборки
├── .dockerignore           # Игнорируемые файлы для Docker
├── README.md               # Документация
└── .gitignore             # Игнорируемые файлы
```

### Описание модулей

- **config/** - содержит конфигурацию логирования и настройки приложения
- **utils/** - утилиты: клиент AI, текстовые сообщения, клавиатуры
- **handlers/** - обработчики команд и сообщений от пользователей
- **bot.py** - точка входа, инициализация и запуск бота

## Технологии

- **pyTelegramBotAPI** - библиотека для работы с Telegram Bot API
- **OpenAI** - клиент для работы с OpenAI API (через ProxyAPI)
- **python-dotenv** - для работы с переменными окружения

## Логирование

Бот использует расширенную систему логирования:

- **Консольный вывод** - логи уровня INFO и выше отображаются в консоли
- **Файл логов** (`logs/bot.log`) - все события уровня DEBUG и выше с ротацией файлов (макс. 10MB, 5 файлов)
- **Файл ошибок** (`logs/errors.log`) - только ошибки уровня ERROR и выше

Логи содержат:
- Время события
- Уровень логирования
- Имя файла и номер строки
- Детальную информацию о запросах и ответах
- Время выполнения запросов к API
- Информацию о пользователях (ID, username, имя)
- Полные traceback для ошибок

## Система памяти

Бот использует **двухуровневую систему памяти** для эффективного хранения контекста:

### Короткая память (Short-term Memory)
- Хранится в оперативной памяти приложения
- Последние **10 сообщений** каждого пользователя
- Используется для поддержания контекста текущего разговора
- Очищается при перезапуске бота

### Долгосрочная память (Long-term Memory)
- Хранится в PostgreSQL базе данных
- Все сообщения сохраняются в БД
- **Автоматическое создание тезисов**: после каждых 3 сообщений пользователя AI генерирует краткие тезисы
- Тезисы накапливаются и добавляются в системный промпт при следующих запросах
- Сокращает размер контекстного окна, сохраняя важную информацию
- Сохраняется между перезапусками бота

### Команды управления памятью
- `/clear` - Очищает всю историю (короткую и долгосрочную память)

## Архитектура памяти

```
┌─────────────────────────────────────────────────────────────┐
│                     Входящее сообщение                       │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
        ┌──────────────────────────────────┐
        │  1. Сохранение в PostgreSQL      │
        │     (таблица messages)           │
        └──────────────┬───────────────────┘
                       │
                       ▼
        ┌──────────────────────────────────┐
        │  2. Загрузка тезисов из БД       │
        │     (таблица theses)             │
        └──────────────┬───────────────────┘
                       │
                       ▼
        ┌──────────────────────────────────┐
        │  3. Загрузка короткой истории    │
        │     (10 последних сообщений)     │
        └──────────────┬───────────────────┘
                       │
                       ▼
        ┌──────────────────────────────────┐
        │  4. Формирование запроса к AI:   │
        │     - Системный промпт + тезисы  │
        │     - Короткая история           │
        │     - Текущее сообщение          │
        └──────────────┬───────────────────┘
                       │
                       ▼
        ┌──────────────────────────────────┐
        │  5. Получение ответа от AI       │
        └──────────────┬───────────────────┘
                       │
                       ▼
        ┌──────────────────────────────────┐
        │  6. Сохранение ответа:           │
        │     - В оперативную память       │
        │     - В PostgreSQL               │
        └──────────────┬───────────────────┘
                       │
                       ▼
        ┌──────────────────────────────────┐
        │  7. Каждые 3 сообщения:          │
        │     Генерация новых тезисов      │
        │     AI анализирует последние     │
        │     сообщения и создает краткие  │
        │     выводы для долгосрочной      │
        │     памяти                       │
        └──────────────────────────────────┘
```

## Примечания

- Бот использует модель `gpt-4.1-mini-2025-04-14` через ProxyAPI
- Все запросы и события логируются для отладки и мониторинга
- Бот работает в режиме long polling
- Логи автоматически ротируются при достижении размера 10MB
- Короткая память хранится в оперативной памяти и очищается при перезапуске
- Долгосрочная память (тезисы и сообщения) хранится в PostgreSQL
- Генерация тезисов происходит автоматически после каждых 3 сообщений пользователя
- Требуется настроенная PostgreSQL база данных

