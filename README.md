# Telegram AI Bot

Telegram бот, который отвечает на вопросы пользователей с помощью AI через ProxyAPI (GPT-4.1-mini).

## Установка

1. Клонируйте репозиторий или скачайте файлы проекта

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

4. Заполните переменные окружения в файле `.env`:
   - `TELEGRAM_BOT_TOKEN` - токен вашего Telegram бота (получить у [@BotFather](https://t.me/BotFather))
   - `OPENAI_API_KEY` - API ключ для ProxyAPI

## Запуск

### Локальный запуск

Запустите бота командой:
```bash
python bot.py
```

### Запуск в Docker

1. Соберите Docker образ:
```bash
docker build -t telegram-ai-bot .
```

2. Запустите контейнер с переменными окружения:
```bash
docker run -d \
  --name telegram-bot \
  -e TELEGRAM_BOT_TOKEN=your_telegram_bot_token \
  -e OPENAI_API_KEY=your_openai_api_key \
  telegram-ai-bot
```

Или используйте файл `.env`:
```bash
docker run -d \
  --name telegram-bot \
  --env-file .env \
  telegram-ai-bot
```

3. Просмотр логов:
```bash
docker logs -f telegram-bot
```

4. Остановка контейнера:
```bash
docker stop telegram-bot
docker rm telegram-bot
```

## CI/CD с GitHub Actions

Проект включает автоматизированный workflow для сборки и развертывания через GitHub Actions.

### Автоматическое развертывание

При push в ветку `main` автоматически:
1. Собирается Docker образ
2. Образ пушится в GitHub Container Registry (ghcr.io)
3. Подключается к удаленному серверу по SSH
4. Развертывается новый контейнер

### Настройка секретов

В настройках репозитория (Settings → Secrets and variables → Actions) добавьте необходимые секреты для деплоя:

- `SSH_PRIVATE_KEY` - Приватный SSH ключ для подключения к серверу
- `SSH_HOST` - IP адрес или доменное имя сервера
- `SSH_USER` - Имя пользователя для SSH подключения
- `SSH_PORT` - Порт SSH (опционально, по умолчанию 22)
- `GHCR_TOKEN` - Personal Access Token (PAT) с правами `read:packages` и `write:packages` для GitHub Container Registry
- `TELEGRAM_BOT_TOKEN` - Токен Telegram бота
- `OPENAI_API_KEY` - API ключ для ProxyAPI

Подробная инструкция по настройке SSH и развертыванию находится в [.github/workflows/README.md](.github/workflows/README.md).

## Использование

1. Найдите вашего бота в Telegram
2. Отправьте команду `/start` для начала работы
3. Задавайте любые вопросы боту - он будет отвечать с помощью AI

## Команды бота

- `/start` - Начать работу с ботом
- `/help` - Показать справку
- `/clear` - Очистить историю разговора

## Структура проекта

Проект организован в модульную структуру:

```
ShortLongMemoryBot/
├── config/                 # Конфигурация приложения
│   ├── __init__.py
│   ├── logging_config.py  # Настройка логирования
│   └── settings.py         # Настройки и переменные окружения
├── utils/                  # Вспомогательные модули
│   ├── __init__.py
│   ├── ai_client.py        # Клиент для работы с OpenAI API
│   ├── messages.py         # Текстовые сообщения бота
│   ├── keyboards.py        # Клавиатуры и кнопки
│   ├── memory.py           # Модуль памяти диалогов
│   └── memory_manager.py   # Менеджер памяти (единый экземпляр)
├── handlers/               # Обработчики событий
│   ├── __init__.py
│   ├── commands.py         # Обработчики команд (/start, /help)
│   └── messages.py         # Обработчики текстовых сообщений
├── bot.py                  # Основной файл запуска бота
├── requirements.txt        # Зависимости проекта
├── Dockerfile              # Docker образ для сборки
├── .dockerignore           # Игнорируемые файлы для Docker
├── README.md               # Документация
└── .gitignore             # Игнорируемые файлы
```

### Описание модулей

- **config/** - содержит конфигурацию логирования и настройки приложения
- **utils/** - утилиты: клиент AI, текстовые сообщения, клавиатуры
- **handlers/** - обработчики команд и сообщений от пользователей
- **bot.py** - точка входа, инициализация и запуск бота

## Технологии

- **pyTelegramBotAPI** - библиотека для работы с Telegram Bot API
- **OpenAI** - клиент для работы с OpenAI API (через ProxyAPI)
- **python-dotenv** - для работы с переменными окружения

## Логирование

Бот использует расширенную систему логирования:

- **Консольный вывод** - логи уровня INFO и выше отображаются в консоли
- **Файл логов** (`logs/bot.log`) - все события уровня DEBUG и выше с ротацией файлов (макс. 10MB, 5 файлов)
- **Файл ошибок** (`logs/errors.log`) - только ошибки уровня ERROR и выше

Логи содержат:
- Время события
- Уровень логирования
- Имя файла и номер строки
- Детальную информацию о запросах и ответах
- Время выполнения запросов к API
- Информацию о пользователях (ID, username, имя)
- Полные traceback для ошибок

## Память диалогов

Бот имеет короткую память и помнит последние **10 сообщений** каждого пользователя для поддержания контекста разговора:

- История хранится в памяти приложения для каждого пользователя отдельно
- При превышении лимита старые сообщения автоматически удаляются
- Пользователь может очистить историю командой `/clear`
- История используется при каждом запросе к AI для более контекстных ответов

## Примечания

- Бот использует модель `gpt-4.1-mini-2025-04-14` через ProxyAPI
- Все запросы и события логируются для отладки и мониторинга
- Бот работает в режиме long polling
- Логи автоматически ротируются при достижении размера 10MB
- Память диалогов хранится в оперативной памяти и очищается при перезапуске бота

